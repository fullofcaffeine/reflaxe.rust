#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"

echo "[pre-commit] Running local path guard on staged changes..."
bash "$ROOT_DIR/scripts/lint/local_path_guard_staged.sh"

if command -v bd >/dev/null 2>&1; then
  echo "[pre-commit] Running bd pre-commit hook (beads flush/staleness)..."
  bd hooks run pre-commit
else
  echo "[pre-commit] WARN: bd not found; skipping beads hook."
fi

echo "[pre-commit] Running gitleaks on staged changes..."
bash "$ROOT_DIR/scripts/security/run-gitleaks.sh" --staged

echo "[pre-commit] Running name-heuristics guard..."
"$ROOT_DIR/scripts/lint/name_heuristics_guard.sh"

echo "[pre-commit] Running numeric-suffix guard..."
"$ROOT_DIR/scripts/lint/numeric_suffix_guard.sh"

echo "[pre-commit] Running Dynamic usage guard..."
"$ROOT_DIR/scripts/lint/dynamic_usage_guard.sh"

STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR || true)"
if printf '%s\n' "$STAGED_FILES" | grep -Eq '^(docs/|README\.md$|\.beads/issues\.jsonl$|scripts/docs/)'; then
  echo "[pre-commit] Running docs progress-tracker drift check..."
  "$ROOT_DIR/scripts/docs/check-progress-tracker.sh"
fi

echo "[pre-commit] OK"
