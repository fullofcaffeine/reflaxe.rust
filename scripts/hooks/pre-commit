#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"

if ! command -v gitleaks >/dev/null 2>&1; then
  echo "[pre-commit] ERROR: gitleaks is required but not installed." >&2
  echo "[pre-commit] Install: https://github.com/gitleaks/gitleaks#installing" >&2
  exit 1
fi

CONFIG_ARGS=()
if [ -f "$ROOT_DIR/.gitleaks.toml" ]; then
  CONFIG_ARGS+=(--config "$ROOT_DIR/.gitleaks.toml")
fi

echo "[pre-commit] Running gitleaks on staged changes..."
GITLEAKS_HELP="$(gitleaks --help 2>&1 || true)"
if printf '%s' "$GITLEAKS_HELP" | grep -q '\<protect\>'; then
  gitleaks protect --staged --redact "${CONFIG_ARGS[@]}"
elif printf '%s' "$GITLEAKS_HELP" | grep -q '\<git\>'; then
  gitleaks git --staged --redact "${CONFIG_ARGS[@]}"
else
  echo "[pre-commit] ERROR: unsupported gitleaks CLI; expected 'protect' or 'git' command." >&2
  exit 1
fi

echo "[pre-commit] Running name-heuristics guard..."
"$ROOT_DIR/scripts/lint/name_heuristics_guard.sh"

echo "[pre-commit] Running numeric-suffix guard..."
"$ROOT_DIR/scripts/lint/numeric_suffix_guard.sh"

echo "[pre-commit] OK"
